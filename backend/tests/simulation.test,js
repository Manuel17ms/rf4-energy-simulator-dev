import request from 'supertest'
import mongoose from 'mongoose'
import app from '../server.js'

describe('POST /api/simulation', () => {

  beforeAll(async () => {
    await mongoose.connect(process.env.MONGODB_URI)
  })

  afterAll(async () => {
    await mongoose.connection.close()
  })

  test('Simulazione valida', async () => {

    const res = await request(app)
      .post('/api/simulation')
      .send({
        squareMeters: 80,
        housingType: 'apartment',
        residents: 2,
        energy: {
          water: 'electricity',
          heating: 'gas',
          cooking: 'electricity'
        },
        locationId: 'loc1',
        sessionId: 'test-session'
      })

    expect(res.statusCode).toBe(200)
    expect(res.body.data).toHaveProperty('estimatedConsumptionKWh')
    expect(res.body.data).toHaveProperty('co2EquivalentKg')
  })

  test('Errore dati mancanti', async () => {

    const res = await request(app)
      .post('/api/simulation')
      .send({})

    expect(res.statusCode).toBe(400)
  })

})
